"use strict";function e(t,s){function l(){t.services.instrumentation.safeExecuteWithoutInstrumentation(()=>i.readdirSync(t.config.bootstrapCfg.tempDir)).filter(function(e){return e.match(new RegExp(m,"mig"))}).forEach(e=>{i.unlink(n.join(t.config.bootstrapCfg.tempDir,e),function(t){t?r.warn("Failed to remove testfile: %s, error: %s",e,t):r.info("testfile: %s, removed successfully",e)})})}function d(){let e=(new Date).getTime();x=n.join(t.config.bootstrapCfg.tempDir,m+e+".txt"),x=a.isWindows()?a.normalizeToUnixPath(x):x,E=y+e;try{return t.services.instrumentation.safeExecuteWithoutInstrumentation(()=>i.writeFileSync(x,E)),!0}catch(e){return r.warn("The checker %s is disabled because it can not create a test file",s),!1}}function p(e){const n=t.services.xmlparser.parseFromString(e),i="seeker"+(new Date).getTime();f(n,"<!ENTITY "+i+" SYSTEM '"+x+"'>",i);let r=t.services.xmlparser.serializeToString(n);const s=new RegExp("&amp;"+i,"g"),o="&"+i;return r=r.replace(s,o)}function f(e,t,n){switch(e.nodeType){case 9:{let i=!1,r;for(r=0;r<e.childNodes.length;r++)if(10===e.childNodes[r].nodeType){i=!0;break}let s=e.implementation.createDocumentType("seeker","","");i?e.replaceChild(s,e.childNodes[r]):e.insertBefore(s,e.childNodes[1]),e.childNodes[1].internalSubset=t;for(let i=0;i<e.childNodes.length;i++)f(e.childNodes[i],t,n);break}case 1:for(let i=0;i<e.childNodes.length;i++)f(e.childNodes.item(i),t,n);break;case 8:case 5:case 3:e.textContent="&"+n+";";break;case 7:null!==e.previousSibling&&e.tagName&&"XML"!==e.tagName.toUpperCase()&&(e.textContent="&"+n+";")}}function h(e,t){return e.length>t?e.toString().substring(0,t):e.toString()}function g(e){for(let t=0;t<T.length;t++)if(e.includes(T[t]))return!0;return!1}e.super_.apply(this,arguments);const m="TESTseeker-xxe-test_",y="XXE-INJECTION-TEST_",T=["text/xml","application/xml","+xml"];let x,E;this.start=function e(){l(),d()&&t.services.http.on(s,"requestEnded",function(e){if(t.services.replay.isActive()&&e.requestData.contentType&&g(e.requestData.contentType)&&"POST"===e.requestData.method){let t=new o(s).withDefaults().withCandidate();e.requestData.headers&&e.requestData.headers[c.REPLAY_ACTIVE_HEADER]&&e.responseData.body&&e.responseData.body.includes(E)&&t.withContext({replayResponseBody:h(e.responseData.body,100),replayTestFile:x,replayTestValue:E}),t.submit()}})},this.isReplayable=function e(){return!0},this.getVerificationValue=function e(){return""},this.getTamperedBody=function e(t){const n=t.extractVulnerableHttpRequestData();if(n&&g(n.contentType))try{return p(String(n.body).toString())}catch(e){return r.warn("Failed to modify xml"),""}},this.getStatusForReplay=function e(t){return t.newFinding.checkerContext&&t.newFinding.checkerContext.replayTestFile?(t.initialFinding.checkerContext={replayResponseBody:t.newFinding.checkerContext.replayResponseBody,replayTestFile:t.newFinding.checkerContext.replayTestFile,replayTestValue:t.newFinding.checkerContext.replayTestValue},u.VERIFIED):u.DELETED}}const t=require("util"),n=require("path"),i=require("fs"),r=require("../util/logger"),s=require("./_AbstractChecker"),o=require("../services/finding-service").FindingBuilder,a=require("../util/misc"),c=require("../entities/enums/replay-header"),u=require("../entities/enums/replay-status");t.inherits(e,s),module.exports=function(t,n){return new e(t,n)};