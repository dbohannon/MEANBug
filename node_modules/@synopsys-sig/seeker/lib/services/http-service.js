"use strict";function e(){function e(e){if("IncomingMessage"===e.constructor.name){let t="";if(T&&(t+=e.method),w&&(t+="_"+e.originalUrl),A){const s=Object.keys(e.params);s.forEach(e=>t+="_"+e)}if(P){const s=Object.keys(e.headers);s.forEach(e=>t+="_"+e)}return t}let t="";if(T&&(t+=e.method),w&&(t+="_"+e.path),A){const s=Object.keys(e.params);s.forEach(e=>t+="_"+e)}if(P){const s=Object.keys(e.headers);s.forEach(e=>t+="_"+e)}return t}function t(){N.services.instrumentation.register({moduleId:"global",wrapperName:"Promise",methodNames:["then","catch"],type:"prototype",callbacks:{__sk_doBefore:function(e,t){if(process.domain)for(let e=0;e<t.length;e++)t[e]=t[e]&&process.domain.bind(t[e])}}})}function k(){const e=N.services.instrumentation;e.register({moduleId:"http",wrapperName:"OutgoingMessage",methodNames:"write",type:"prototype",callbacks:{__sk_doBefore:function(e,t){const s=t[0];g.emit("responseWrite",{value:s}),v(s)}}}),e.register({moduleId:"hapi/lib/response",methodNames:"wrap",callbacks:{__sk_doBefore:function(e,t){const s=t[0];g.emit("responseWrite",{value:s}),v(s)}}}),e.register({moduleId:"events",wrapperName:"EventEmitter",methodNames:"emit",type:"prototype",callbacks:{__sk_doBefore:function(e,t){if(e instanceof n.IncomingMessage&&process.domain&&process.domain.__sk_local&&"data"===t[0]){const s=t[1],o=e.headers["content-type"];o&&(o.includes("application/json")?N.services.datatainting.taintSourceRecursively(s,p.HTTP_BODY_JSON,"body"):o.includes("application/x-www-form-urlencoded")&&N.services.datatainting.taintSourceRecursively(s,p.HTTP_BODY,"body"));const n=process.domain.__sk_local.requestData;if(I(n.headers)){if(n.body){let e=n.body,t=h.safeBufferFrom(s);e&&t&&(n.body=Buffer.concat([e,t],e.length+t.length))}else n.body=h.safeBufferFrom(s);const t=parseInt(e.headers["content-length"]);if(n.body&&n.body.length===t&&o.includes("application/x-www-form-urlencoded")){const e=a.parseBodyParams(n.body.toString());n.params=Object.assign(n.params,e)}}}}}}),e.register({moduleId:"http",wrapperName:"ServerResponse",methodNames:"end",type:"prototype",callbacks:{__sk_doBefore:function(e,t){const s=t[0];if(s&&r.gte(process.version,"8.0.0")&&g.emit("responseWrite",{value:s}),process.domain&&process.domain.__sk_local&&(v(s),process.domain.__sk_local.responseData.body)){process.domain.__sk_local.responseEnded=!0;const e=process.domain.__sk_local.getResponseHeader("content-encoding");e&&e.includes("gzip")&&S()}}}}),["http","https"].forEach(t=>{e.register({moduleId:t,methodNames:"request",type:"instance",callbacks:{__sk_doBefore:function(e,s){const o=s[0];g.emit("requestSent",o,t)}}})}),e.register({moduleId:"request/request",methodNames:"<init>",type:"instance",callbacks:{__sk_doBefore:function(e,t){const s=t[0];g.emit("requestSent",s,"request")}}}),e.register({moduleId:"http",wrapperName:"OutgoingMessage",methodNames:"setHeader",type:"prototype",callbacks:{__sk_doBefore:function(e,t){const s=t[0],o=t[1];if("set-cookie"===s.toLocaleLowerCase()){const e=Array.isArray(o)?o:[o];for(let t=0;t<e.length;t++)g.emit("cookieSent",e[t])}process.domain&&process.domain.__sk_local&&process.domain.__sk_local.getResponseHeader(s)!==o&&(process.domain.__sk_local.responseData.headers[s]=o)}}}),e.register({moduleId:"http",wrapperName:"ServerResponse",methodNames:"writeHead",type:"prototype",callbacks:{__sk_doBefore:function(e,t){if(process.domain&&process.domain.__sk_local&&t.length>1){const e=t[2]||("string"!=typeof t[1]?t[1]:void 0);e&&Object.assign(process.domain.__sk_local.responseData.headers,e)}}}}),e.register({moduleId:"jsonparse/jsonparse",methodNames:"write",type:"prototype",callbacks:{__sk_doBefore:function(e,t){const s=N.services.datatainting.getTaintInfo(t[0]);s&&N.services.datatainting.propagate(e,s,d.VALUE_UPDATE)}}}),e.register({moduleId:"jsonparse/jsonparse",methodNames:"onToken",type:"prototype",callbacks:{__sk_doBefore:function(e){if(e.string&&e.key){let t=N.services.datatainting.getTaintInfo(e);if(t){t.sourceName="";for(let s=0;s<e.stack.length;++s)e.stack[s].key&&(t.sourceName+="/"+e.stack[s].key);t.sourceName+="/"+e.key,N.services.datatainting.propagate(e.string,t,d.VALUE_UPDATE,!0)}}}}}),e.register({moduleId:"bfj/src/index",methodNames:"unpipe",callbacks:{__sk_doBefore:function(e,t){const s=t[0];t[0]=function(e,t){if(process.domain&&process.domain.__sk_local&&process.domain.__sk_local.requestData&&process.domain.__sk_local.requestData.body){const e=N.services.datatainting.getTaintInfo(process.domain.__sk_local.requestData.body);e?(N.services.datatainting.propagate(t,e,d.VALUE_UPDATE,!0),b(t,"")):i.warn("Missing tainted info for request.body in bfj.unpipe")}else i.warn("Missing domain in bfj.unpipe instrumentation");s(e,t)}}}})}function y(){const e=N.services.instrumentation;e.register({moduleId:"url",methodNames:"parse",type:"instance",callbacks:{__sk_doBefore:function(e,t){let s={},o=N.services.datatainting.getTaintInfo(t[0]);return o&&(s={taintInfo:o}),s},__sk_doAfter:function(e,t,s,o){if(t){let e=o?o.taintInfo:void 0;e&&s.length>1&&!0===s[1]&&N.services.datatainting.taintParams(t.query)}return t}}}),e.register({moduleId:"querystring",methodNames:"parse",type:"instance",callbacks:{__sk_doBefore:function(e,t){let s={},o=N.services.datatainting.getTaintInfo(t[0]);return o&&(s={taintInfo:o}),s},__sk_doAfter:function(e,t,s,o){if(t){let e=o?o.taintInfo:void 0;e&&N.services.datatainting.taintParams(t)}return t}}}),e.register({wrapperName:"JSON",methodNames:"parse",type:"instance",callbacks:{__sk_doBefore:function(e,t){let s={},o=N.services.datatainting.getTaintInfo(t[0]);return o&&(s={taintInfo:o}),s},__sk_doAfter:function(e,t,s,o){if(t){let e=o?o.taintInfo:void 0;e&&(N.services.datatainting.propagate(t,e,d.VALUE_UPDATE,e.sourceType===p.HTTP_BODY_JSON),e.sourceType===p.HTTP_BODY_JSON&&b(t,""))}return t}}}),e.register({moduleId:"querystring",methodNames:"stringify",type:"instance",callbacks:{__sk_doBefore:function(e,t){const s=t[0],o=function(e){for(let t in e)null===e[t]||"object"!=typeof e[t]||N.services.datatainting.isTainted(e[t])||o(e[t])};"object"==typeof s&&o(s)}}}),e.register({moduleId:"formidable/lib/incoming_form",wrapperName:"IncomingForm",methodNames:"parse",type:"prototype",callbacks:{__sk_doBefore:function(e,t){const s=t[1];t[1]=function(e,t,o){N.services.datatainting.taintSourceRecursively(t,p.HTTP_PARAM),s(e,t,o)}}}})}function b(e,t){Object.keys(e).forEach(s=>{const o=N.services.datatainting.getTaintInfo(e[s]);o&&(o.sourceName=t+(e instanceof Array?"["+s+"]":"/"+s),b(e[s],o.sourceName))})}function v(e){if(process.domain&&process.domain.__sk_local&&e)if(process.domain.__sk_local.responseData.body){if(!process.domain.__sk_local.responseEnded){let t=process.domain.__sk_local.responseData.body,s=h.safeBufferFrom(e);t&&s&&(process.domain.__sk_local.responseData.body=Buffer.concat([t,s],t.length+s.length))}}else process.domain.__sk_local.responseData.body=h.safeBufferFrom(e)}function S(){if(process.domain&&process.domain.__sk_local&&process.domain.__sk_local.responseData.body)try{process.domain.__sk_local.responseData.body=o.gunzipSync(process.domain.__sk_local.responseData.body)}catch(e){i.warn("Tried to unzip a response body with a content-encoding 'gzip' that is not zipped"),i.warn(e)}}function I(e){let t=Object.keys(e).find(e=>"content-length"===e.toLowerCase());if(t&&e[t].length>0){let s=e[t][0];if(s&&s>0)return!0}return!1}let N;const E={"content-type":["multipart"]},q=new Map;let D=!1;const T="false"!==process.env.SEEKER_SAMPLING_METHOD,w="false"!==process.env.SEEKER_SAMPLING_PATH,A="false"!==process.env.SEEKER_SAMPLING_PARAMS,P="false"!==process.env.SEEKER_SAMPLING_HEADERS,R=1e3*(Number(process.env.SEEKER_SAMPLING_INVALIDATE_INTERVAL)||30),B=Number(process.env.SEEKER_SAMPLING_INVALIDATE_COUNT)||50,L=Number(process.env.SEEKER_SAMPLING_START_THRESHOLD)||1;this.skipRequestIfNeeded=function(t){if(!D)return!1;if(t.headers["x-synopsys-seeker-replay-active"]||t.headers["x-synopsys-seeker-replay-auto"])return!0;if("POST"===t.method&&t.headers["content-type"]&&t.headers["content-type"][0]&&(t.headers["content-type"][0].startsWith("application/json")||t.headers["content-type"][0].startsWith("application/xml")))return!0;const s=h.hashCode(e(t)),o=q.get(s);return o?!(++o.count<L)&&((o.count-L)%B!=0&&(new Date-o.time>R?(o.time=new Date,!1):(process.domain.__sk_local.__sk_skip=!0,!0))):(q.set(s,{time:new Date,count:1}),!1)},this.isSkip=function(){return process.domain&&process.domain.__sk_local.__sk_skip},this.init=function(e){N=e,k(),l.handleInstrumentation(N),f.handleInstrumentation(N),m.handleInstrumentation(N),y()},this.start=function(){N.services.collector.on("ProjectCfg.Push",e=>{const t=e.data.projectCfg.projectEnvCfgs.default.processCfgs.default;D!==t.features.includes("SAMPLING")&&(D=t.features.includes("SAMPLING"),i.info("Sampling mode is %s",D?"on":"off"))}),D=N.config&&N.config.processCfg&&N.config.processCfg.features.includes("SAMPLING"),i.info("Sampling mode is %s",D?"on":"off")},this.setCurrentRestTemplate=function(e){const t=g.getCurrentRequestData();t&&(t.path=e)},this.pathsMap=new Map,this.instrumentHttpServer=function(e){e.Server.prototype.__sk_emit||(t(),e.Server.prototype.__sk_emit=e.Server.prototype.emit,e.Server.prototype.emit=function(){const t=[].slice.call(arguments,0),o=this;let n=!1;if("request"===t[0]){if(t[1].headers)for(let e in E){const s=t[1].headers[e];if(s)for(let t=0;t<E[e].length;++t)if(s.includes(E[e][t])){n=!0;break}if(n)break}if(!n){const n=t[1],r=t[2],a=s.create();let i={requestData:new u(n),responseData:{headers:{},statusCode:r.statusCode,body:void 0},getResponseHeader:function(e){return this.responseData.headers[Object.keys(this.responseData.headers).find(t=>t.toLowerCase()===e.toLowerCase())]},getRequestHeader:function(e){return this.requestData.headers[Object.keys(this.requestData.headers).find(t=>t.toLowerCase()===e.toLowerCase())]}};return a.__sk_local=i,a.run(function(){this.__sk_requestFinish=function(){const e=s.create();i.reqHostname=n.hostname,i.reqSessionID=n.sessionID,i.responseData.statusCode=r.statusCode,e.__sk_local=i,e.run(function(){g.emit("requestEnded",i)})},this.__sk_requestStarted=function(){N.services.datatainting.taintSource(null,n.url,{sourceValue:n.url,sourceName:"url",sourceType:p.HTTP_PATH,flowStateData:new c(d.SOURCE,n.url,void 0,N.services.datatainting.includeStacktrace())}),N.services.datatainting.taintSourceRecursively(n.headers,p.HTTP_HEADER),g.emit("requestStarted",i)},g.skipRequestIfNeeded(i.requestData),process.domain&&process.domain.__sk_local.__sk_skip||(this.__sk_requestStarted(),r.on("finish",this.__sk_requestFinish)),e.Server.prototype.__sk_emit.apply(o,t)})}}e.Server.prototype.__sk_emit.apply(o,t)})},this.getCurrentRequestData=function(){return process.domain&&process.domain.__sk_local?process.domain.__sk_local.requestData:null},this.parseCookieHeader=function(e){let t=new _,s=e.split(";");if(s.length>0){let e=s[0].split("=");t.name=e[0],e.length>1&&(e.shift(),t.value=decodeURIComponent(e.toString())),s.shift(),s.length>0&&["httponly","secure"].forEach(e=>t.options[e]=s.toString().toLocaleLowerCase().includes(e))}return t},this._clearCache=function(){q.clear()}}const t=require("util"),s=require("domain"),o=require("zlib"),n=require("http"),r=require("semver"),a=require("../util/http-utils"),i=require("../util/logger"),c=require("../entities/flow-state-data"),d=require("../entities/enums/flowstate-data-type"),p=require("../entities/enums/source-type"),u=require("../entities/http-request-data"),_=require("../entities/cookie-data"),l=require("./http/http-hapi"),f=require("./http/http-express"),m=require("./http/http-koa"),h=require("../util/misc");t.inherits(e,require("./_AbstractService"));const g=module.exports=new e;