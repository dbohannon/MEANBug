"use strict";function e(){function e(e){e.requestDatas.forEach(e=>{e&&e.body&&(e.body=i(e.body))}),e.replayData&&e.replayData.request&&e.replayData.request.body&&(e.replayData.request.body=i(e.replayData.request.body)),delete e.isCandidate;for(let t=0;t<e.flowStates.length;t++)r(e.flowStates[t])}function i(e){return Array.prototype.slice.call(e,0)}function r(e){e.stacktrace=e.stacktrace.split("\n").filter(function(e){return!o(e)}).join("\n")}function o(e){return-1!==e.indexOf(q.modulePath+"lib")||-1!==e.indexOf(q.modulePath+"node_modules")||-1!==e.indexOf(D)}function u(){if(0!==C.length){let e=C.filter(e=>{if(e.isCandidate)return s.trace("Skipping submit of candidate finding: %j",e),!1;s.trace("Submit of a new finding: %j",e);return!0});C=C.filter(e=>e.isCandidate),e.length>0?c(e).then(()=>setTimeout(u,k)):setTimeout(u,k)}else setTimeout(u,k)}function c(t){return C.concat(t.slice(v)),(t=t.slice(0,v)).forEach(t=>{e(t)}),q.services.collector.wsSend({command:"Findings.Push",data:{type:"com.synopsys.seeker.commons.objects.messages.data.FindingsPushCommandData",findings:t}})}function f(){if(0!==A.length){const e=Date.now()-1e3*E;let t=[];A.forEach(i=>{i.createdOn<e?(s.trace("Did not received the replay request in the expected interval (%s s), finding will be submitted without verification: %s",E,n.inspect(i)),C.push(i.initialFinding)):t.push(i)}),A=t,setTimeout(f,E)}else setTimeout(f,E)}function l(e,t){const i=t.extractVulnerableHttpRequestData();if(q.services.replay.isActive()&&i&&!i.getFirstHeader(d.REPLAY_ACTIVE_HEADER)&&e.isReplayable(t)){const i=e.getTamperedBody(t),n=e.getTamperedValue(t),r={uuid:q.services.instrumentation.safeExecuteWithoutInstrumentation(a.generateUUID),createdOn:Date.now(),initialFinding:t,checker:e,tamperedValue:n,tamperedBody:i,errors:[]};return A.push(r),q.services.replay.replay(r),!0}return!1}function y(e,t){const i=t.extractVulnerableHttpRequestData();if(!i)return!1;if(i.getFirstHeader(d.REPLAY_ACTIVE_HEADER)&&i.getFirstHeader(d.REPLAY_FOR_HEADER)){const e=i.getFirstHeader(d.REPLAY_FOR_HEADER),n=A.find(t=>t.uuid===e);if(n){if(t.isSharingSameVulnerability(n.initialFinding))return n.newFinding=t,!0}else s.trace("Could not find the original finding for this replay: %s",t)}else if(i.getFirstHeader(d.REPLAY_ACTIVE_HEADER)||i.getFirstHeader(d.REPLAY_AUTO_HEADER))return t.replayData={request:i},t.origin=p.REPLAY,!1;return!1}function w(e){return!S(e)||(s.trace("Discard a finding caused by the Agent itself: %j",e),!1)}function S(e){let t=e.extractCodeSignature();return t&&o(t)}function m(e){const t=a.getCheckerProbeName(e);return!q.config.processCfg.probesArgs[t]||"true"===q.config.processCfg.probesArgs[t].active}const E=30;let q,C=[],A=[],k=1e3;const v=parseInt(process.env.SEEKER_FINDINGS_BULK_SIZE)||100;this.FindingBuilder=function(e){return new t(q,e)},this.init=function(e){q=e},this.start=function(){const e=q.config.processCfg.flushInterval;e&&(s.trace("Set flush interval to %s (user setting)",e),k=1e3*e),u(),f()},this.add=function(e){let t=!1;const i=q.checkers[e.checkerKey];if(w(e)){if(q.services.finding.upgradeToSecondOrderFinding(e)&&(t=!0,q.services.finding.dropSecondOrderFinding(e)))return!1;if(!t){if(y(i,e))return;if(l(i,e))return}C.push(e)}},this.upgradeToSecondOrderFinding=function e(t){let i,n;if(t.flowStates)for(let e=0;e<t.flowStates.length&&(t.flowStates[e].type===g.SOURCE?i=t.flowStates[e].requestDataUuid:t.flowStates[e].type===g.SINK_USAGE&&(n=t.flowStates[e].requestDataUuid),!i||!n);e++);return!!i&&(n!==i&&(s.info("Finding was upgraded to a second order finding: %s",JSON.stringify(t)),t.checkerKey=t.checkerKey+"-SECOND-ORDER",!0))},this.dropSecondOrderFinding=function(e){return!m(e.checkerKey)},this.unmarkDirty=function(e){const t=e.initialFinding;C.push(t),A=A.filter(t=>t.uuid!==e.uuid),t.replayData&&t.replayData.status!==h.DELETED&&t.isCandidate&&(t.isCandidate=!1)},this.getDirtyFindings=function(){return A},this.validate=w,this._submitFindings=c,this._clean=function(){C=[],A=[]}}function t(e,t){function n(){const t=e.services.process_version;return t.isFeatureEnabled()?t.getProjectVersion():null}let d=new l(t,e.config.bootstrapCfg.executionUuid,n());d.origin=p.DEFAULT,this.withCurrentRequest=function(){let t=e.services.http.getCurrentRequestData();return null===t||d.requestDatas.includes(t)||d.requestDatas.push(r(t)),this},this.withResponseHeaders=function(e){return d.checkerContext||(d.checkerContext={}),d.checkerContext.responseHeaders=o.formatHeadersForContext(e.responseData.headers),this},this.withVulnerableSource=function(e,t){return d.vulnerableSourceName=e,d.vulnerableSourceType=t,this},this.withLastFlowState=function(){return e.config.projectCfg.checkerCfgs[d.checkerKey].aggregateByCodeLocation?d.flowStates.push(new f(g.SINK_USAGE,null,d.getRequestUUID(),!0)):d.shouldAddLastFlowstate=!0,this},this.withDataTaintingFlowStates=function(t){let i=e.services.datatainting.getTaintInfo(t);do{let e=!1;d.flowStates.unshift(i.flowStateData),i.requestData&&i.flowStateData.type!==g.SINK_USAGE&&(d.requestDatas.forEach(t=>{t.uuid===i.requestData.uuid&&(e=!0)}),e||d.requestDatas.unshift(i.requestData)),i=i.parent}while(i);return d.flowStates.push(new f(g.SINK_USAGE,t,d.getRequestUUID(),!0)),this},this.withDefaults=function(){return this.withCurrentRequest().withLastFlowState()},this.withCandidate=function(){return d.isCandidate=!0,this},this.withTaintedDefaults=function(t){const i=e.services.datatainting.getTaintInfo(t);return this.withCurrentRequest().withVulnerableSource(i.sourceName,i.sourceType).withDataTaintingFlowStates(t)},this.withContext=function(e){d.checkerContext=e;const t=Object.keys(e);for(let n=0;n<t.length;++n)e[t[n]]=i(e[t[n]],"checker context");return this},this.withIdentityContextKey=function(e){return this.identityCheckerContextKeys||(this.identityCheckerContextKeys=[]),this.identityCheckerContextKeys.push(e),this},this.maskAllSensitiveInformation=function(e,t){if(e.requestDatas){let i=new Map,n=new Map,r=[];for(let r=0;r<t.length;++r)t[r].hideRequestParamValue&&(t[r].type!==y.HTTP_PARAM&&"ALL"!==t[r].type||e.requestDatas.forEach(e=>{c.checkMatchers(e.path,t[r],e.params,e=>{i.set(e,1)})}),t[r].type!==y.HTTP_HEADER&&"ALL"!==t[r].type||e.requestDatas.forEach(e=>{c.checkMatchers(e.path,t[r],e.headers,e=>{n.set(e,1)})}));i=Array.from(i.keys()),n=Array.from(n.keys());for(let t=0;t<i.length;++t)e.requestDatas.forEach(e=>{const n=e.params[i[t]];if(n)for(let t=0;t<n.length;++t)e.url=a.replaceAll(e.url,n[t],u.sensitiveDataMask),r.push(n[t]),n[t]=u.sensitiveDataMask});for(let t=0;t<n.length;++t)e.requestDatas.forEach(e=>{const i=e.headers[n[t]];if(i)for(let e=0;e<i.length;++e)r.push(i[e]),i[e]=u.sensitiveDataMask});r=a.removeDuplicatesAndEmptyValues(r);for(let t=0;t<r.length;++t)for(let i=0;i<e.requestDatas.length;++i)if(e.requestDatas[i]&&e.requestDatas[i].body){let n=e.requestDatas[i].body.toString();n=a.replaceAll(n,r[t],u.sensitiveDataMask),e.requestDatas[i].body=Buffer.from(n,"utf-8")}for(let t=0;t<r.length;++t)for(let i=0;i<e.flowStates.length;++i)e.flowStates[i].value&&(e.flowStates[i].value=a.replaceAll(e.flowStates[i].value,r[t],u.sensitiveDataMask));for(let t=0;t<r.length;++t)for(let i in e.checkerContext)e.checkerContext[i]&&(e.checkerContext[i]=a.replaceAll(e.checkerContext[i],r[t],u.sensitiveDataMask))}},this.submit=function(){e.checkers[d.checkerKey].getCustomScopeFilter().toSubmit(d)?(d.shouldAddLastFlowstate&&(d.flowStates.push(new f(g.SINK_USAGE,null,d.getRequestUUID(),!0)),delete d.shouldAddLastFlowstate),d.identityCheckerContextKeys=void 0,this.maskAllSensitiveInformation(d,e.config.processCfg.projectEnvCfg.sensitiveParameterMatchers),module.exports.add(d)):s.debug("Finding was filtered by scope filter %s",JSON.stringify(d))}}function i(e){if(!e||"number"==typeof e||"string"==typeof e||e instanceof String)return e;const t=JSON.stringify(e);return s.warn("Tried to write an object as a 'context', with value: "+t),t}const n=require("util"),r=require("clone"),s=require("../util/logger"),a=require("../util/misc"),o=require("../util/http-utils"),u=require("../util/crypto-utils"),c=require("../util/sensitive-matcher"),f=require("../entities/flow-state-data"),l=require("../entities/finding-data"),d=require("../entities/enums/replay-header"),h=require("../entities/enums/replay-status"),g=require("../entities/enums/flowstate-data-type"),p=require("../entities/enums/detection-origin"),y=require("../entities/enums/source-type"),D=require("../../package.json").name;module.exports=new e;