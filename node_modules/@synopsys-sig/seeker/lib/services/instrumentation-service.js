"use strict";function InstrumentationService(){function isExcluded(e){for(let t=0;t<excludeFilters.length;t++)if(excludeFilters[t].test(e))return!0;return!1}function patchMethod(e,t){if("<init>"!==t.methodName){if("constructor"===t.type){if(agent.services["sourcecode-instrumentation"].registerConstructor(t),e=global.__sk_inst_functions,t.identifiers){for(let r=0;r<t.identifiers.length;++r){const n={moduleId:t.moduleId,wrapperName:"__sk_inst_functions",methodName:t.methodName+t.identifiers[r]+t.wrapperName+"Ctor",type:"instance",callbacks:t.callbacks};patchMethod(e,n)}return}t.methodName+=("global"!==t.moduleId?t.moduleId:"")+t.wrapperName+"Ctor",t.wrapperName="__sk_inst_functions",t.type="instance"}"prototype"===t.type&&(e&&e.prototype?e=e.prototype:logger.warn("Failed to find method to patch: '%s.%s.%s()'!",t.moduleId,t.wrapperName||"[prototype]",t.methodName)),e&&e[t.methodName]?shimmer.wrap(e,t.methodName,function(e){return logger.trace("Wrapping method: %s",JSON.stringify(t)),wrapWithBeforeAfterCallbacks(e,t)}):t.optional||logger.warn("Failed to find method to patch: '%s.%s.%s()'!",t.moduleId,t.wrapperName||"[default]",t.methodName)}}function updateWrapperStatData(e,t,r){let n=wrapperStatData[e];n.doBeforeTime+=t,n.doAfterTime+=r,n.count++}function wrapWithBeforeAfterCallbacks(e,t){const r=t.callbacks;let n=t.moduleId+"_"+t.wrapperName+"_"+t.methodName;if(wrapperStatData[n]=new WrapperStat,"String"===e.name){const r=wrapWithName(e,t);if(r)return r}return function __sk_wrapWithBeforeAfterCallbacks(){let a=0,o=0,i;const s=arguments;let l,u,c=e.name;return r.__sk_doBefore&&isEnableInstrumentationCallback&&!agent.services.http.isSkip()&&(isDebugWrappers&&(i=process.hrtime()),thisModule.safeExecuteWithoutInstrumentation(()=>{try{SEEKER_TRACE_INST&&instLogger.log("BEFORE",t),"TRACE_NO_AGENT"!==SEEKER_TRACE_INST&&(u=r.__sk_doBefore(this,s,c))}catch(e){logger.trace("Sink doBefore callback failed with error: %s",e.stack)}}),isDebugWrappers&&(a=process.hrtime(i)[1]/1e6)),l=e.apply(this,s),r.__sk_doAfter&&isEnableInstrumentationCallback&&!agent.services.http.isSkip()&&(isDebugWrappers&&(i=process.hrtime()),thisModule.safeExecuteWithoutInstrumentation(()=>{try{SEEKER_TRACE_INST&&instLogger.log("AFTER",t),"TRACE_NO_AGENT"!==SEEKER_TRACE_INST&&(l=r.__sk_doAfter(this,l,s,u))}catch(e){logger.trace("Sink doAfter callback failed with error: %s",e.stack)}}),isDebugWrappers&&(o=process.hrtime(i)[1]/1e6)),isDebugWrappers&&updateWrapperStatData(n,a,o),l}}function wrapWithName(original,config){const callbacks=config.callbacks;let f;const str="const "+original.name+" = function "+original.name+`() {\n      const args = arguments;\n\n      let callbackContext;\n      if (callbacks.__sk_doBefore && isEnableInstrumentationCallback) {\n        instService.safeExecuteWithoutInstrumentation(() => {\n          try {\n            if (SEEKER_TRACE_INST) {\n              instLogger.log('BEFORE', config);\n            }\n            if (SEEKER_TRACE_INST !== 'TRACE_NO_AGENT') {\n              callbackContext = callbacks.__sk_doBefore(this, args);\n            }\n          } catch (error) {\n            logger.trace('Sink doBefore callback failed with error: %s', error.stack);\n          }\n        });\n      }\n\n      let result = original.apply(this, args);\n\n      if (callbacks.__sk_doAfter && isEnableInstrumentationCallback) {\n        instService.safeExecuteWithoutInstrumentation(() => {\n          try {\n            if (SEEKER_TRACE_INST) {\n              instLogger.log('AFTER', config);\n            }\n            if (SEEKER_TRACE_INST !== 'TRACE_NO_AGENT') {\n              result = callbacks.__sk_doAfter(this, result, args, callbackContext);\n            }\n          } catch (error) {\n            logger.trace('Sink doAfter callback failed with error: %s', error.stack);\n          }\n        });\n      }\n\n      return result;\n    };\n    f = `+original.name+";";return eval(str),f}function isInstrumentModuleExport(e){let t=!1;const r=listeners.get(e);if(r)for(let e=0;e<r.length;++e)"<init>"===r[e].methodName.toLowerCase()&&(t=!0);return t}function patchModuleMethods(e,t,r){if(loadedModules.hasFilePath(e))return null;let n=null;"http"!==t&&"https"!==t||(agent.services.http.instrumentHttpServer(r),n=r);let a=listeners.get(t);if(!a||0===a.length)return loadedModulesBeforeAgent.set(t,""),n;isInstrumentModuleExport(t)||loadedModules.set(t,e);for(let e=0;e<a.length;e++){const o=a[e];let i=o.wrapperName?r[o.wrapperName]:r;if(i)if("<init>"===o.methodName){(n=wrapWithBeforeAfterCallbacks(i,o)).prototype=i.prototype;const e=Object.keys(i);for(let t=0;t<e.length;++t)n[e[t]]=i[e[t]]}else n=r,patchMethod(i,o);else logger.warn("Invalid configuration for the instrumentation, object '%s' in module '%s' does not exist!",o.wrapperName,t)}return"buffer"===t&&(global.Buffer=r.Buffer),n}function extractModuleId(e){let t=(e=misc.normalizeToUnixPath(e)).lastIndexOf("/node_modules/");if(-1===t)return e;const r=e.substring(t+14);return t=r.lastIndexOf("."),-1===t?r:r.substring(0,t)}let agent;const listeners=new Map,inProgressLoadingModules=new Map,loadedModulesBeforeAgent=new LoadedModulesMetaData,loadedModules=new LoadedModulesMetaData;let excludeFilters=[],isEnableInstrumentationCallback=!0;this.cleanup=function(){shimmer.unwrap(require("module"),"_load")},this.init=function(e){function t(e,t,r){let n;try{inProgressLoadingModules.set(r,!0),n=e.apply(this,t)}finally{inProgressLoadingModules.delete(r)}return n}agent=e,loadedModules.clear();const r=require("module");shimmer({logger:misc.inDevOrTest()?logger.warn:logger.debug}),shimmer.wrap(r,"_load",function(e){return function(n,a,o){const i=thisModule.safeExecuteWithoutInstrumentation(()=>r._resolveFilename(n,a,o));if(inProgressLoadingModules.has(i))return e.apply(this,arguments);const s=thisModule.safeExecuteWithoutInstrumentation(()=>t(e,arguments,i));if(isExcluded(i))return logger.debug("File %s is excluded from instrumentation",i),s;const l=extractModuleId(i),u=patchModuleMethods(i,l,s,arguments);return null!==u&&logger.trace("Module patched: %s",i),thisModule.emit("moduleLoaded",{moduleId:l,filePath:i,module:s,originalFile:n}),u||s}})},this.start=function(){excludeFilters=agent.config&&agent.config.projectCfg&&agent.config.projectCfg.techClassMatcherMap.NODEJS&&agent.config.projectCfg.techClassMatcherMap.NODEJS.excludes?agent.config.projectCfg.techClassMatcherMap.NODEJS.excludes.map(e=>{let t=e.replace("*",".*");misc.isWindows()&&(t=t.replace("/","\\"));return new RegExp(t)}):{}},this.register=function(e){const t=e.moduleId||"global",r=e.methodNames?"string"==typeof e.methodNames?[e.methodNames]:e.methodNames:["<init>"];let n;if("global"===t||"fs"===t||"child_process"===t||"url"===t)n=!0;else try{n=!!require.cache[require.resolve(t)]}catch(e){n=!1}const a=r=>({moduleId:t,wrapperName:e.wrapperName,methodName:r,type:e.type,optional:e.optional,identifiers:e.identifiers,callbacks:e.callbacks});if(n){const n="global"===t?global:require(t),o=e.wrapperName?n[e.wrapperName]:n;if("global"!==t){const n=require.cache[require.resolve(t)];n?!loadedModules.hasFilePath(n.filename)&&o?(r.forEach(e=>patchMethod(o,a(e))),r.includes("<init>")||loadedModules.set(t,n.filename)):logger.trace("Module {%s} is already loaded and will not be patched...",JSON.stringify(e)):(r.forEach(e=>patchMethod(o,a(e))),loadedModules.set(t,t))}else r.forEach(e=>patchMethod(o,a(e)))}let o=listeners.get(t);o||(o=[],listeners.set(t,o)),r.forEach(e=>o.push(a(e)))},this.moduleLoaded=function(e){return loadedModules.hasModuleId(e)||loadedModulesBeforeAgent.hasModuleId(e)},this.safeExecuteWithoutInstrumentation=function(e){isEnableInstrumentationCallback=!1;try{const t=e();return isEnableInstrumentationCallback=!0,t}catch(e){throw isEnableInstrumentationCallback=!0,e}},this.safeExecuteWithInstrumentation=function(e){if(isEnableInstrumentationCallback)return e();isEnableInstrumentationCallback=!0;try{const t=e();return isEnableInstrumentationCallback=!1,t}catch(e){throw isEnableInstrumentationCallback=!1,e}},this.getWrappersStatData=function(){return isDebugWrappers?wrapperStatData:void 0},this.extractModuleId=extractModuleId}const util=require("util"),shimmer=require("shimmer"),logger=require("../util/logger"),instLogger=require("../util/inst-logger"),misc=require("../util/misc"),WrapperStat=require("../entities/wrapper-stat"),wrapperStatData={},isDebugWrappers=process.env.SEEKER_WRAPPER_PROFILING,SEEKER_TRACE_INST=process.env.SEEKER_TRACE_INST,LoadedModulesMetaData=function(){const e=new Map,t=new Map;this.set=function(r,n){e.set(r,!0),t.set(n,!0)},this.hasModuleId=function(t){return e.has(t)},this.hasFilePath=function(e){return t.has(e)},this.clear=function(){e.clear(),t.clear()}};util.inherits(InstrumentationService,require("./_AbstractService"));const thisModule=module.exports=new InstrumentationService;