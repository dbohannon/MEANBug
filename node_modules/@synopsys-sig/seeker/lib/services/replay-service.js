"use strict";function e(){function e(e){let t={};return Object.keys(e).forEach(n=>t[n]=e[n][0]),t}function l(t){return new Promise((a,c)=>{const l=t.dirtyFinding;const m=l?l.initialFinding:void 0;const y=l?l.tamperedValue:void 0;let g;y?g=y:(l&&!l.verificationValues&&(l.verificationValues=l.checker.getVerificationValues(l)),g=l?l.verificationValues.shift():t.verificationValue);const v=m?m.extractVulnerableHttpRequestData():t.requestData;const b=v.headers["content-type"];const q=!(!b||!b.some(e=>e.includes("application/json")));const E=!(!b||!b.some(e=>e.includes("application/x-www-form-urlencoded")));const D=t.unusedParameter;const P=t.emptyParameterName;const _=m?m.vulnerableSourceName:void 0;const A=l?l.tamperedBody:void 0;const S=l&&l.checker&&l.checker.getVerificationMethod()?l.checker.getVerificationMethod():v.method;const R=v.url;const V=r.parse(R,!0);let k=V.pathname;s.trace("Replay %s with %s",JSON.stringify(v),g);let T=V.query;if(g&&m)switch(m.vulnerableSourceType){case u.HTTP_PARAM:if(m&&m.vulnerableSourceName){if(E&&d(v.body.toString(),q,!0)[m.vulnerableSourceName])break;T=f(V.query,m.vulnerableSourceName,g)}break;case u.HTTP_PATH_PARAM:v.path&&m.vulnerableSourceName&&v.path.includes(":"+m.vulnerableSourceName)&&(k=v.path.split(":"+m.vulnerableSourceName).join(g));break;case u.HTTP_HEADER:v.headers=h(v.headers,m.vulnerableSourceName,g);break;case u.HTTP_COOKIE:v.headers=p(v.headers,m.vulnerableSourceName,g)}P&&(T=f(V.query,P,g));D&&"GET"===D.method&&(T[D.name]=g);const N=n.stringify(T);T&&N.length&&(k+="?"+N);const H={hostname:V.hostname,port:V.port,path:k,method:S,headers:e(v.headers)};let w="";if("POST"===S){if((q||E)&&g&&""!==g){let e,t;if(m)if(m.vulnerableSourceType===u.HTTP_BODY_JSON){if(m.flowStates[0].getJsonBody&&(e=d(m.flowStates[0].getJsonBody().toString(),!0,!0))&&m&&m.vulnerableSourceName){const t=m.vulnerableSourceName.substring(1).replace(/\//g,".");i.set(e,t,g),w=d(e,!0,!1)}}else w=d(t=f(e=d(v.body.toString(),q,!0),_,g),q,!1);else P?w=d(t=f(e=d(v.body.toString(),q,!0),P,g),q,!1):D&&"POST"===D.method&&(E||q)&&((e=d(v.body?v.body.toString():"",q,!0))[D.name]=g,w=d(e,q,!1))}else A&&(w=A);w.length>0&&(H.headers["Content-Length"]=Buffer.byteLength(w))}D||P?H.headers[o.REPLAY_AUTO_HEADER]="true":(H.headers[o.REPLAY_ACTIVE_HEADER]="true",H.headers[o.REPLAY_FOR_HEADER]=l.uuid,H.headers[o.REPLAY_FOR_CHECKER]=l.checker.id);const O=R.startsWith("https")?require("https"):require("http");const F=O.request(H,e=>{const t=[];e.on("data",e=>t.push(e));e.on("end",()=>a(t.join("")))});F.on("error",e=>c(e));F.end(w)})}function d(e,t,r){return g.services.instrumentation.safeExecuteWithoutInstrumentation(function(){return t?r?JSON.parse(e):JSON.stringify(e):r?n.parse(e):n.stringify(e)})}function f(e,t,n){return e[t]=n,e}function h(e,t,n){return e[t]&&e[t]instanceof Array&&(e[t][0]=n),e}function p(e,t,n){if(e.cookie&&e.cookie instanceof Array&&e.cookie[0]){const r=e.cookie[0].split(";");for(let e=0;e<r.length;++e){const i=r[e].split("=");if(2===i.length){const a=i[0];let s=i[1];a===t&&(s=n,r[e]=a+"="+s)}}e.cookie[0]=r.join(";")}return e}function m(e,n){if(global.Proxy&&e)return new Proxy(e,{get:function(e,r){if("string"==typeof r&&!(r in e)&&t.active&&t.active.__sk_local){const e=t.active.__sk_local;e.unusedParameters||(e.unusedParameters=new Map),e.unusedParameters.set(r,{name:r,method:n})}return e[r]}})}function y(e,t){let n=a.hashCode(e);return n=31*n+a.hashCode(t)}let g;const v="3223",b=new Map,q=new Map;this.init=function(e){const t=this;(g=e).services.instrumentation.register({moduleId:"express/lib/router/layer",methodNames:"handle_request",type:"prototype",callbacks:{__sk_doBefore:function(e,n){if(t.isActive()){const e=n[0];e.query=m(e.query,"GET"),e.body=m(e.body,"POST")}}}})},this.start=function(){s.info("Continous mode is %s",this.isActive()?"on":"off"),this.isActive()&&g.services.http.on(null,"requestEnded",function(e){e.requestData.headers[o.REPLAY_ACTIVE_HEADER]||e.requestData.headers[o.REPLAY_AUTO_HEADER]||(e.unusedParameters&&e.unusedParameters.forEach(t=>{const n=y(e.requestData.path,t.name);q.has(n)?s.trace("Replay ignored for request "+e.requestData.path+" because of already replayed with this param: "+t.name):(l({requestData:e.requestData,verificationValue:"3223",unusedParameter:t}),q.set(n,!0))}),Object.keys(e.requestData.params).forEach(t=>{let n=e.requestData.params[t];if(n&&n.length>0&&0===n[0].length){const n=y(e.requestData.path,t);q.has(n)?s.trace("Replay ignored for request "+e.requestData.path+" because of already replayed with this param: "+t):(l({requestData:e.requestData,verificationValue:"3223",emptyParameterName:t}),q.set(n,!0))}}))})},this.isActive=function(){return g.config&&g.config.processCfg&&g.config.processCfg.features.includes("REPLAY")},this.replay=function(e){const t=e=>{const n=e.checker;const r=e.newFinding;if(r)if(e.tamperedValue){if(!n.getTamperedStatus(e))return void(e.initialFinding.replayData={request:r.extractVulnerableHttpRequestData(),status:c.ELIMINATED});e.tamperedValue=void 0}else if(e.initialFinding.replayData={request:r.extractVulnerableHttpRequestData()},e.initialFinding.replayData.status=n.getStatusForReplay(e),e.initialFinding.replayData.status===c.VERIFIED)return void g.services.finding.unmarkDirty(e);e.verificationValues||(e.verificationValues=n.getVerificationValues(e));e.verificationValues.length>0?l({dirtyFinding:e}).then(()=>t(e),()=>t(e)):g.services.finding.unmarkDirty(e)},n=e.initialFinding.buildVulnerabilityHash();b.has(n)?(s.trace("Replay ignored for finding, because of already replayed this vulnerability",e),g.services.finding.unmarkDirty(e)):(b.set(n,!0),l({dirtyFinding:e}).then(()=>t(e),()=>t(e)))},this._clearCache=function(){b.clear(),q.clear()}}const t=require("domain"),n=require("querystring"),r=require("url");let i=require("lodash");const a=require("../util/misc"),s=require("../util/logger"),o=require("../entities/enums/replay-header"),u=require("../entities/enums/source-type"),c=require("../entities/enums/replay-status");module.exports=new e;