"use strict";function e(){function e(){return new Promise(()=>{const e=h.config.bootstrapCfg;let o=i.getConnectionOptions({perMessageDeflate:!1},e.collectorWsProtocol);S=new n(t.format(e.collectorWsProtocol+"://%s:%s/ws/agents/%d/plain/%s",e.collectorHost,e.collectorPort,R,e.executionUuid),o);S.on("open",function(){T=!0,v()});S.on("message",function(e){g.trace("Received Web Socket message: "+e),e=JSON.parse(e),module.exports.emit(e.command,e)});S.on("close",function(e,o){T=!1,g.info("Web socket disconnected (cause: [%s] %s), will try to reconnect in background",e,o),p(!0)});S.on("error",function(e){g.error("Web socket encountered an error: %s",JSON.stringify(e))})})}function f(e){h.config.processCfg=e.processCfg,h.config.projectCfg=e.processCfg.projectEnvCfg.projectCfg,h.config.collectorCfg=e.collectorCfg,l(),h.services.instrumentation.safeExecuteWithoutInstrumentation(()=>{h.config.bootstrapCfg.homeDir=i.resolveHomeDir();h.config.bootstrapCfg.tempDir=i.resolveTempDir();h.config.storageDir=i.prepareStorageDir(h.config)}),g.init({dir:i.getLogDir(h),level:h.config.processCfg.projectEnvCfg.diagLevel,agent:h}),g.debug("Config fetched from the Server: %j",e),_!==e.collectorVersion&&g.warn(`Seeker versions are misaligned!\n/!\\\n/!\\ The version of the Agent (%s) is different from the version of the Server (%s).\n/!\\ Please, ensure that all components are upgraded and restarted, you might encounter unexpected issues otherwise.\n/!\\`,_,e.collectorVersion)}function l(){h.config.processCfg.projectEnvCfg.sensitiveParameterMatchers=h.config.processCfg.projectEnvCfg.sensitiveParameterMatchers.filter(e=>e.enabled);const e=h.config.processCfg.projectEnvCfg.sensitiveParameterMatchers;if(e)for(let o=0;o<e.length;++o)e[o].parameterNameRegexRule=new RegExp(e[o].parameterNamePattern,"i"),e[o].parameterValueRegexRule=new RegExp(e[o].parameterValuePattern,"i"),e[o].originalUrlStringRegexRule=new RegExp(e[o].originalUrlString,"i")}function p(e){if(!1===e){const e=d();return u(e,!0)}m()}function u(o,t){return!o||o.code?(t&&(console.error("Failed to connect to the Server, process will start without the Agent (cause: "+(o?JSON.stringify(o):"N/A")+")"),o&&(404===o.code&&console.error("The Seeker Agent got an error while trying to communicate with the Seeker Server, ensure that the port set as part of the URL in the environment variable named 'SEEKER_SERVER_URL' does not point to the server Web UI port. I.e., it is set to 8082/8484 instead of 9911/9912.\nConsider following the instructions provided by the Server UI for connecting a new Agent ('Connect' button)."),i.inDevOrTest()&&o.stack&&console.error(o.stack))),!1):(f(o),o.findingSubmissionInterval&&a.prototype.setFindingSubmissionInterval(o.findingSubmissionInterval),e(),!0)}function E(){const e=h.config.bootstrapCfg;h.config.bootstrapCfg.agentVersion=_;const o={key:e.processKey,processKey:e.processKey,version:_};e.projectKey?o.projectKey=e.projectKey:h.config.projectCfg&&(o.projectKey=h.config.projectCfg.key);const n=t.format("/rest/internal/%d/agents/%s",R,e.executionUuid),i=r.stringify(o),g=s.resolve(__dirname,"..","bootstrap-cfg-resolver.js"),a={protocol:e.collectorHttpProtocol,host:e.collectorHost,port:e.collectorPort,path:n,data:i,userAgent:c};return process.env.SEEKER_KEYSTORE_PATH&&process.env.SEEKER_KEYSTORE_PASSWORD&&(a.SEEKER_KEYSTORE_PATH=process.env.SEEKER_KEYSTORE_PATH,a.SEEKER_KEYSTORE_PASSWORD=process.env.SEEKER_KEYSTORE_PASSWORD),{file:process.execPath,arg:[g],processEnv:a}}function d(){const e=E(),t=(new Date).getTime();let r;r=process.env.SEEKER_AGENT_CONNECTION_TIMEOUT?Number(process.env.SEEKER_AGENT_CONNECTION_TIMEOUT):process.env.SEEKER_SENSOR_CONNECTION_TIMEOUT?Number(process.env.SEEKER_SENSOR_CONNECTION_TIMEOUT):120;let n,s=!0;do{try{const t=o.execFileSync(e.file,e.arg,{timeout:Math.min(2e4,1e3*r),env:e.processEnv});n=JSON.parse(t)}catch(e){g.trace("Failed to parse agent config response")}n&&!n.code||!s||(console.log("Cannot connect to the Enterprise Server at "+i.resolveCollectorUrl()+". Giving a chance to the Enterprise Server to start ("+r+"s max)"),console.log("NB: Ensure the Enterprise Server is started before you launch your application to avoid the waiting time"),s=!1)}while((!n||n.code)&&t+1e3*r>(new Date).getTime());return n}function m(){function e(e,o){let t;if(N++,e)return g.info("failed to exec bootstrap-cfg-resolver "+e),void setTimeout(m,N<10?5e3:6e4,!0);try{t=JSON.parse(o)}catch(e){g.trace("Failed to parse agent config response")}t&&u(t)?(h.services.processexec.submit(),g.info("Connection to the Server reestablished on attempt #%s!",N),N=0):(g.info("Failed to connect to the Server on attempt #%s (%s)",N,t?JSON.stringify(t):"N/A"),setTimeout(m,N<10?5e3:6e4))}const t=E();try{o.execFile(t.path,t.arg,{timeout:2e4,env:t.processEnv},e)}catch(e){m()}}function v(){g.info(`Sending ${O.length} delayed messages`);for(let e=0;e<O.length;++e)module.exports.wsSend(O[e]);O=[]}let h,S,C=1;const R=8;let T=!1,O=[],N=0,_;this.init=function(e){h=e,_=i.formatUcVersionFromSemVer(h.packageInfo.version)},this.connect=p,this.wsSend=function(e){return new Promise((o,t)=>{if(T){const r={id:C++,command:e.command,data:e.data};e.replyTo&&(r.replyTo=e.replyTo),S.send(JSON.stringify(r),function e(r){r?(g.trace("Error while sending a WebSocket message: %j",r),t(r)):o()})}else e&&"ProcessExec.Push"===e.command&&O.push(e),o()})},this.getUserAgent=function(){return c},this.on("PingPong.Keepalive",e=>{this.wsSend(e)}),this.on("ProjectCfg.Push",e=>{const o="default";h.config.projectCfg=e.data.projectCfg;h.config.processCfg=e.data.projectCfg.projectEnvCfgs[o].processCfgs[o];h.config.processCfg.projectEnvCfg=e.data.projectCfg.projectEnvCfgs[o];l();const t=e.data.projectCfg.projectEnvCfgs[o].diagLevel;h.config.collectorCfg.logging.level=t;h.config.collectorCfg.logging.loggers["com.synopsys"]=t;h.config.collectorCfg.logging.appenders[0].threshold=t;g.setLevel(t)}),this._digestAgentConfig=f,this._handleIncomingCfgAndConnectWS=u}const o=require("child_process"),t=require("util"),r=require("querystring"),n=require("ws"),s=require("path"),c="Seeker Node.js Agent",i=require("../util/misc"),g=require("../util/logger");let a=require("./filters/custom-finding-scope-filter");t.inherits(e,require("events").EventEmitter),module.exports=new e;