"use strict";function t(){function t(t){return t?i.getTaintedInfo(t):null}function f(e,n,i){let o=t(e);if(!o){o=[];for(let e=0;e<n.length;e++)if(n[e]){const r=t(n[e]);if(r)o.push(r);else if(i&&"object"==typeof n[e]&&!(n[e]instanceof Array)&&!(n[e]instanceof RegExp)&&n[e].toString){const i=n[e].toString();if("[object Object]"!==i){const e=t(i);e&&o.push(e)}}}}return o&&0===o.length?void 0:o}function l(t,e,n){if(!t||void 0===t)return null;if(i.isTainted(t)){const o=i.getTaintedInfo(t);e.found=!0,e.taintedObject=t,e.taintedObjectsMap.set(o.sourceName,{taintedData:o,path:n})}else"object"!=typeof t||e.refs.has(t)||(e.refs.set(t,!0),Object.keys(t).forEach(i=>{l(t[i],e,n+(""===n?"":".")+i)}))}function p(e,n,i,o,r){if(o=o||!1,!e)return e;if(!n&&!(n=t(e)))return e;if(n instanceof Array){const t=d(n);(n=n[n.length-1]).sanitizedFor=t}e.constructor&&("Object"===e.constructor.name||e instanceof Array)&&Object.keys(e).forEach(t=>{p(e[t],n,i,o)}),U.services.datatainting.taintUpdate(null,e,{sourceValue:n.sourceValue,sourceName:n.sourceName,sourceType:n.sourceType,sanitizedFor:n.sanitizedFor,parent:n,flowStateData:o?new u(i,e,void 0,R):new a(i,e.toString(r),void 0,R)})}function d(t){const e=t[0].sanitizedFor;for(let n=1;n<t.length;++n){if(!(e&&e.length>0))return[];for(let i=0;i<e.length;++i)t[n].sanitizedFor&&t[n].sanitizedFor.includes(e[i])||e.splice(i,1)}return e}function g(t,e,n){const o=null===t?e:t[e];"object"!=typeof e&&"string"!=typeof e||i.taint(o,n)}function h(t){return t&&"string"==typeof t?i.cloneString(t):t}function m(t){return t?(U.services.instrumentation.safeExecuteWithoutInstrumentation(()=>{y(t)}),t):t}function y(t){if(t.sourceValue=h(t.sourceValue),t.sourceName=h(t.sourceName),t.flowStateData&&(t.flowStateData.value=h(t.flowStateData.value)),t.requestData){if(t.requestData.path=h(t.requestData.path),t.requestData.contentType=h(t.requestData.contentType),t.requestData.headers){const e={};Object.keys(t.requestData.headers).forEach(n=>{const i=h(n);e[i]=[];for(let o=0;o<t.requestData.headers[n].length;++o)e[i].push(h(t.requestData.headers[n][o]))}),t.requestData.headers=e}if(t.requestData.params){const e={};Object.keys(t.requestData.params).forEach(n=>{const i=h(n);e[i]=[];for(let o=0;o<t.requestData.params[n].length;++o)e[i].push(h(t.requestData.params[n][o]))}),t.requestData.params=e}}}function _(t){U.services.instrumentation.register({moduleId:t.module,wrapperName:t.wrapper,methodNames:t.method,type:t.definition,optional:t.optional,callbacks:{__sk_doAfter:function e(n,i,o,r){if(i){const e=!t.method.includes("__sk_object"),a=r?r.taintInfo:f(n,o,e);a&&p(i,a,t.type)}return i}}})}function v(){E.forEach(function(t){!1!==t.enabled&&_(t)})}function S(e){U.services.instrumentation.register({moduleId:e.moduleId,wrapperName:e.wrapper,methodNames:e.method,type:e.definition,optional:e.optional,callbacks:{__sk_doBefore:function(n,i){if(!1!==e.argument){const n=t(i[e.argument]);n&&(n.sanitizedFor||(n.sanitizedFor=[]),n.sanitizedFor=n.sanitizedFor.concat(e.types))}},__sk_doAfter:function(n,i){if(!1!==e.result){const n=t(i);n&&(n.sanitizedFor||(n.sanitizedFor=[]),n.sanitizedFor=n.sanitizedFor.concat(e.types))}return i}}})}function T(){O.forEach(function(t){!1!==t.enabled&&S(t)})}function D(){function e(e,n){Object.defineProperty(e,"__sk_original_"+n,{get:Object.getOwnPropertyDescriptor(e,n).get,set:Object.getOwnPropertyDescriptor(e,n).set}),Object.defineProperty(e,n,{get:function(){const e=this["__sk_original_"+n],i=t(this);if(i&&(p(e,i,s.VALUE_UPDATE),"object"==typeof e&&e[Symbol.iterator])){const t=e[Symbol.iterator];e[Symbol.iterator]=function(){const e=t.apply(this,arguments),n=e.next;return e.next=function(){const t=n.apply(this,arguments);if(t.value&&t.value.length>0)for(let e=0;e<t.value.length;++e)U.services.datatainting.taintSource(null,t.value[1],{sourceValue:t.value[1],sourceName:t.value[0],sourceType:c.HTTP_PARAM,flowStateData:new a(s.SOURCE,t.value[1],void 0,R)});return t},e}}return e},set:function(t){this["__sk_original_"+n]=t}})}const o=U.services.instrumentation;o.register({moduleId:"fs",methodNames:["writeFile","writeFileSync"],type:"instance",callbacks:{__sk_doBefore:function(e,n){let i={},r=n[1];const a=t(r);return a&&("string"==typeof r||"object"==typeof r&&r instanceof String)&&(o.safeExecuteWithInstrumentation(()=>{n[1]=Buffer.from(r)}),i={taintInfo:a}),i},__sk_doAfter:function(t,e,n,i){if(e){const t=i?i.taintInfo:null;t&&(e=p(e,t,s.VALUE_UPDATE))}return e}}}),o.register({wrapperName:"Array",methodNames:["join","toLocaleString"],type:"prototype",callbacks:{__sk_doAfter:function e(n,i,o){if(i){const e=[];for(let i=0;i<n.length;++i){const o=t(n[i]);o&&e.push(o)}if(o&&o.length>0){const n=t(o[0]);n&&e.push(n)}e.length>0&&p(i,e,s.VALUE_UPDATE)}return i}}}),o.register({wrapperName:"String",methodNames:"match",type:"prototype",callbacks:{__sk_doAfter:function e(n,o,r){let a;if(o&&(i.isTainted(n)?a=t(n):r&&r.length>0&&i.isTainted(r[0])&&(a=t(r[0])),a))for(let t=0;t<o.length;++t)p(o[t],a,s.VALUE_UPDATE);return o}}}),o.register({module:"buffer",wrapperName:"Buffer",methodNames:"from",type:"instance",callbacks:{__sk_doAfter:function e(n,i,o){if(i){const e=t(o[0]);e&&p(i,e,s.VALUE_UPDATE,!1,o[1])}return i}}}),n.URL&&n.URL.prototype&&(e(n.URL.prototype,"hash"),e(n.URL.prototype,"host"),e(n.URL.prototype,"hostname"),e(n.URL.prototype,"href"),e(n.URL.prototype,"origin"),e(n.URL.prototype,"password"),e(n.URL.prototype,"pathname"),e(n.URL.prototype,"port"),e(n.URL.prototype,"protocol"),e(n.URL.prototype,"search"),e(n.URL.prototype,"username"),e(n.URL.prototype,"searchParams")),o.register({moduleId:"url",identifiers:["url","Url"],wrapperName:"URL",methodNames:"new",type:"constructor",callbacks:{__sk_doAfter:function e(n,i,o){if(i){const e=t(o[0]),n=t(o[1]);if(e||n){const t=e&&n?[n,e]:e||n;p(i,t,s.VALUE_UPDATE)}}return i}}})}function w(){if(U.config.processCfg&&U.config.processCfg.projectEnvCfg&&U.config.processCfg.projectEnvCfg.techSanitizersMap){const t=U.config.processCfg.projectEnvCfg.techSanitizersMap.NODEJS;for(let e=0;e<t.length;e++){const n=t[e];let i=n.method.trim(),a=i.indexOf("(");-1!==a&&(i=i.substring(0,a)),-1!==(a=i.lastIndexOf("."))&&a!==i.length-1?S({moduleId:r.normalizeToUnixPath(i.substring(0,a)),method:i.substring(a+1),types:n.types,optional:!0}):o.warn("Invalid sanitizer definition, will be ignored: %s",i)}}}function b(){U.services.http.on(null,"requestBodyInitialized",(t,e)=>{const n=t.headers["content-type"];e&&n&&n.includes("application/x-www-form-urlencoded")&&U.services.datatainting.taintSourceRecursively(e,c.HTTP_BODY,"",!0);U.services.datatainting.taintSourceRecursively(t.query,c.HTTP_PARAM);U.services.datatainting.taintSourceRecursively(t.headers,c.HTTP_HEADER);U.services.datatainting.taintSourceRecursively(t.params,c.HTTP_PATH_PARAM);U.services.datatainting.taintSourceRecursively(t.cookies,c.HTTP_COOKIE);U.services.datatainting.taintSourceRecursively(t.state,c.HTTP_COOKIE)})}function A(){R=U.config&&U.config.processCfg&&U.config.processCfg.features&&U.config.processCfg.features.includes("DATAFLOW_STACKTRACES")}const E=require("../resources/propagators.json"),O=require("../resources/sanitizers.json");let U={},R=!1;this.init=function(t){U=t},this.start=function(){b(),v(),T(),D(),require("buffer"),w(),A()},this.getTaintInfo=t,this.taintParams=function(t){for(let e in t){const n=t[e];U.services.datatainting.taintSource(t,e,{sourceValue:n,sourceName:e,sourceType:c.HTTP_PARAM,flowStateData:new a(s.SOURCE,n,void 0,R)})}},this.taintUpdate=function(t,e,n){n&&(n.requestData=process.domain&&process.domain.__sk_local?process.domain.__sk_local.requestData:void 0),n&&U.services.instrumentation.safeExecuteWithoutInstrumentation(()=>{n.flowStateData.value=h(n.flowStateData.value)}),g(t,e,n)},this.taintSource=function(t,e,n){n&&(n.requestData=process.domain&&process.domain.__sk_local?process.domain.__sk_local.requestData:void 0),g(t,e,m(n))},this.taintSourceRecursively=function(t,e,n,i){if(t){if(t.constructor&&"Object"===t.constructor.name)Object.keys(t).forEach(o=>{const r=i?(n||"")+"/"+o:o;const c=t[o];"string"==typeof c||c instanceof String?U.services.datatainting.taintSource(t,o,{sourceValue:c,sourceName:r,sourceType:e,flowStateData:new a(s.SOURCE,c,void 0,R)}):U.services.datatainting.taintSourceRecursively(c,e,r,i)});else if(t instanceof Array)for(let i=0;i<t.length;++i){const o=t[i];("string"==typeof o||o instanceof String)&&U.services.datatainting.taintSource(null,o,{sourceValue:o,sourceName:n,sourceType:e,flowStateData:new a(s.SOURCE,o,void 0,R)})}e!==c.HTTP_BODY_JSON&&e!==c.HTTP_BODY||U.services.datatainting.taintSource(null,t,{sourceValue:t,sourceName:n,sourceType:e,flowStateData:e===c.HTTP_BODY_JSON?new u(s.SOURCE,t,void 0,R):new a(s.SOURCE,t,void 0,R)})}},this.isTainted=function(t){return i.isTainted(t)},this.isTaintedAndNotSanitized=function(e,n){if(i.isTainted(e)){const i=t(e);return i&&(!i.sanitizedFor||-1===i.sanitizedFor.indexOf(n))}return!1},this.isTaintedRecursively=function(t){const n={found:!1,refs:new Map,taintedObjectsMap:new Map};return l(t,n,""),n.found?(n.query=e.inspect(t,!1,10),n):null},this.includeStacktrace=function(){return R},this.propagate=p,this._registerPropagatorInstrumentation=_,this._registerUserSanitizers=w,this._initIncludeStacktrace=A,this._cloneString=h,this._getAgent=function(){return U}}const e=require("util"),n=require("url"),i=require("./../../native-tainted-map"),o=require("../util/logger"),r=require("../util/misc"),a=require("../entities/flow-state-data"),s=require("../entities/enums/flowstate-data-type"),c=require("../entities/enums/source-type"),u=require("../entities/json-flow-state-data");module.exports=new t;