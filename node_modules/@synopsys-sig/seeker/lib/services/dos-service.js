"use strict";function n(){function n(){r.services.instrumentation.on(null,"moduleLoaded",n=>{if(d.has(n.moduleId))return;d.add(n.moduleId);if(!n.module)return;const o=r.services.instrumentation.safeExecuteWithoutInstrumentation(()=>e.existsSync(n.moduleId));if(o)return;const c=t(n.module,n.moduleId);c.size>0&&(s.trace("Auto registering the following functions for dos-sync checker: "+n.moduleId+" -> ["+Array.from(c.values()).map(n=>n.syncFunction)+"]"),c.forEach((e,t)=>{e.syncFunction=e.moduleId+"."+e.syncFunction;e.asyncFunction=e.moduleId+"."+e.asyncFunction;delete e.moduleId;n.module[t]&&0===Object.keys(n.module[t]).length&&(l.find(e=>n.moduleId.includes(e))?i(n.moduleId,t,e,"storageSyncCall"):a.find(e=>n.moduleId.includes(e))?i(n.moduleId,t,e,"networkSyncCall"):i(n.moduleId,t,e,"generalSyncCall"))}))})}function t(n,e){const t=Object.keys(n),o=new Map;for(let n=0;n<t.length;++n){const s=t[n]+"Sync";if(t.includes(s))o.set(s,{moduleId:e,syncFunction:s,asyncFunction:t[n]});else{const s=t[n]+"Async";if(t.includes(s))o.set(t[n],{moduleId:e,syncFunction:t[n],asyncFunction:s});else if(t[n].endsWith("Sync")){const s=t[n].substr(t[n].lastIndexOf("Sync"),4)+"Async";t.includes(s)&&o.set(t[n],{moduleId:e,syncFunction:t[n],asyncFunction:s})}}}return o}function i(n,e,t,o){r.services.instrumentation.register({moduleId:n,methodNames:e,type:"instance",callbacks:{__sk_doBefore:function(){module.exports.emit(o,t)}}})}function c(){r.services.instrumentation.register({moduleId:"crypto",methodNames:"randomBytes",type:"instance",callbacks:{__sk_doBefore:function(n,e){e.length<2&&module.exports.emit("generalSyncCall",{syncFunction:"crypto.randomBytes(number)",asyncFunction:"crypto.randomBytes(number, callback)"})}}}),r.services.instrumentation.register({moduleId:"dns",methodNames:"lookup",type:"instance",callbacks:{__sk_doBefore:function(){module.exports.emit("networkSyncCall",{syncFunction:"dns.lookup",asyncFunction:"dns.resolve"})}}}),r.services.instrumentation.register({moduleId:"adm-zip/adm-zip",methodNames:"<init>",callbacks:{__sk_doAfter:function(n,e,o){return t(e,"adm-zip").forEach((n,t)=>{n.syncFunction=n.moduleId+"."+n.syncFunction;n.asyncFunction=n.moduleId+"."+n.asyncFunction;delete n.moduleId;const s=e[t];e[t]=function e(){return module.exports.emit("storageSyncCall",n),s.apply(this,o)}}),e}}})}function u(){r.services.instrumentation.register({wrapperName:"JSON",methodNames:"parse",type:"instance",callbacks:{__sk_doBefore:function(n,e){m&&module.exports.emit("jsonParse",e[0])}}}),r.services.instrumentation.register({moduleId:"body-parser/lib/types/json",methodNames:"<init>",callbacks:{__sk_doBefore:function(n,e){const t=e[0].limit;t||(m=!0);const s=o(t);m=s>f,module.exports.jsonLimit=f}}}),r.services.instrumentation.register({moduleId:"co-body/lib/json",methodNames:"<init>",callbacks:{__sk_doBefore:function(n,e){const t=e[1].limit;t||(m=!0);const s=o(t);m=s>y,module.exports.jsonLimit=y}}})}let r;const d=new Set,l=["fs","graceful-fs","fs-extra"],a=["dgram","dns","http","http2","https","net","tls"];let m;const f=102400,y=1048576;this.jsonLimit=null,this.init=function(e){r=e,n(),u()},this.start=function(){c()}}const e=require("fs"),t=require("util"),o=require("bytes"),s=require("../util/logger");t.inherits(n,require("./_AbstractService")),module.exports=new n;