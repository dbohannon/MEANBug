"use strict";const r=require("fs"),e=require("os"),n=require("path"),t=require("util"),i=require("url").parse,s=Math.random;module.exports={isWindows:function(){return process.platform.startsWith("win")},isString:function r(e){return"string"==typeof e||e instanceof String},normalizeToUnixPath:function(r){return this.isWindows()?r.replace(/\\/g,"/"):r},inDevOrTest:function r(){return"development"===process.env.NODE_ENV||"test"===process.env.NODE_ENV},createTempDir:function t(){return r.mkdtempSync(n.join(e.tmpdir(),"synopsys-seeker-"))},mkDirsSync:function e(n,t){let i=this.normalizeToUnixPath(n),s=[];for(;i&&i.length&&!r.existsSync(i);)s.push(i),i=i.substr(0,i.lastIndexOf("/"));for(let e=s.length-1;e>=0;--e)r.mkdirSync(s[e],t)},prepareWritableDir:function e(n){if(!r.existsSync(n))try{this.mkDirsSync(n)}catch(r){return!1}try{return r.accessSync(n,r.W_OK),!0}catch(r){return!1}},prepareStorageDir:function r(e){const i="agents",s=n.join(e.bootstrapCfg.homeDir,"agents");if(this.prepareWritableDir(s))return s;const o=n.join(e.bootstrapCfg.tempDir,"agents");if(!this.prepareWritableDir(o))throw t.format("Cannot create a writable directory, tried with %s and %s!",s,o);return o},bufferToString:function r(e,n){e instanceof Buffer||(e=Buffer.from(e));let t=!1;!0===n&&e.length>100&&(e=e.slice(0,100),t=!0);let i=e.toString();return t&&(i+="..."),i},bufferToStringExcerpt:function r(e){return this.bufferToString(e,!0)},formatUcVersionFromSemVer:function r(e){if("development"===process.env.NODE_ENV)return"dev";try{const r=/^(\d{4})\.(\d{1,2})\.(\d{1,2})(-SNAPSHOT)?(\.\d{14})?$/.exec(e),n=r[1],t=String("00"+r[2]).slice(-2),i=r[3],s=r[4]||"";return n+"."+t+("0"===i?"":"-SP"+i)+s}catch(r){return e}},generateUUID:function r(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){const e=16*s()|0;return("x"===r?e:3&e|8).toString(16)})},resolveHomeDir:function r(){let t=process.env.SEEKER_HOME_DIR;return t&&this.prepareWritableDir(t)?t:(t=__dirname.includes("@synopsys-sig/seeker/lib/utils")?n.join(__dirname,"../../../../.."):void 0,t&&this.prepareWritableDir(t)?t:e.tmpdir())},resolveTempDir:function r(){const n=process.env.SEEKER_TEMP_DIR;return this.prepareWritableDir(n)?n:e.tmpdir()},resolveCollectorUrl:function r(){const e=process.env.SEEKER_SERVER_URL;return e||"http://localhost:9911"},parsePasswordFromConnectionString(r){return function(r){const e={host:(r=i(r,!0)).hostname,port:r.port,database:r.pathname.substr(1)};if(r.auth){const n=r.auth.split(":");e.user=n.shift(),e.password=n.join(":")}if(r.query)for(let n in r.query){const t=r.query[n];try{e[n]=JSON.parse(t)}catch(r){e[n]=t}}return e}(r).password},connectionStringFromConfig(r,e){return e+"://"+r.user+":"+r.password+"@"+r.host+":"+r.port+"/"+r.database},hashCode:function(r){if(!r)return 0;let e=0;for(let n=0;n<r.length;n++){const t=r.charCodeAt(n);e=(e<<5)-e+t,e&=e}return e},removeDuplicatesAndEmptyValues:function(r){const e=this.isString;return r.filter(function(n,t){return n&&(!e(n)||n.length>0)&&r.indexOf(n)===t})},replaceAll:function(r,e,n){return"string"==typeof r||r instanceof String?r.split(e).join(n):r},isNative:function(r){return/\{\s*\[native code\]\s*\}/.test(""+r)},getCheckerProbeName(r){return"checker."+this.replaceAll(r.toLowerCase(),"-","_")},getInstDir(){return n.resolve(this.resolveHomeDir(),"agents","inst","node")},clearInstDir(){const e=this.getInstDir();if(r.existsSync(e)){const t=r.readdirSync(e);t.forEach(t=>{r.unlinkSync(n.resolve(e,t))})}},resolveHostname(){return e.hostname()},resolveOsFamily(){switch(String(e.type)){case"Linux":return"LINUX";case"Windows_NT":return"WINDOWS";case"Darwin":return"MAC";default:return"OTHER"}},resolveSystemEnvironment(){return r.existsSync("/.dockerenv")||"ContainerAdministrator"===process.env.USERNAME?"DOCKER":process.env.WEBSITE_INSTANCE_ID?"AZURE":process.env.CF_INSTANCE_IP?"PCF":null},resolveIpAddresses(){const r=e.networkInterfaces(),n=[];for(const e in r)for(const t in r[e]){const i=r[e][t];"IPv4"!==i.family||i.internal||n.push(i.address)}return n},getLogDir(r){return n.join(r.config.storageDir,"logs","node")},safeBufferFrom:function(r){if(r&&(r instanceof Buffer||"string"==typeof r||r instanceof String||r instanceof Array||r instanceof ArrayBuffer))return Buffer.from(r)},getConnectionOptions(e,n){let t=process.env.SEEKER_KEYSTORE_PATH,i=process.env.SEEKER_KEYSTORE_PASSWORD;return process.env.NODE_TLS_REJECT_UNAUTHORIZED=0,t&&i&&("https"===n||"wss"===n)&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED=1,e.pfx=r.readFileSync(t),e.passphrase=i,e.checkServerIdentity=(()=>void 0)),e},getCheckerId(r){return r?"checker."+r.toLowerCase().replace("-","_"):r}};