"use strict";function e(){function e(e,t){return{type:"MemberExpression",computed:!1,object:"string"==typeof e?j(e):e,property:"string"==typeof t?{type:"Identifier",name:t}:t}}function s(t,n,r){return{type:"CallExpression",callee:e(t,n),arguments:r||[]}}function y(e,t){return{type:"AssignmentExpression",operator:"=",left:e,right:t}}function w(e,t){return{type:"UnaryExpression",operator:e,argument:t,prefix:!0}}function C(e,t,n){return{type:"ConditionalExpression",test:e,consequent:t,alternate:n}}function k(e,t,n){return{type:"LogicalExpression",operator:e,left:t,right:n}}function b(e){return{type:"ArrayExpression",elements:e}}function x(e){return w("delete",e)}function E(e){return{type:"Literal",value:e}}function j(e){return{type:"Identifier",name:e}}function S(e){const t=E(!1);return 1===e.length?k("&&",e[0],t):k("||",k("&&",e.shift(),t),S(e))}function v(e){let t=o.cloneDeep(e.arguments);return e.arguments&&(e.arguments[e.arguments.length-1]=s("__sk_inst_functions","sourceCode",[e.arguments[e.arguments.length-1]])),k("||",s("__sk_inst_functions","eval",t),e)}function F(t){const n="__sk_process_domain_"+ ++__sk_inst_functions.asyncDomainCounter,r="__sk_await_result_"+__sk_inst_functions.asyncDomainCounter,o=s("__sk_inst_functions","deleteOldAwaitResultsWithoutDomain"),i=y(e("__sk_inst_functions",n),e("process","domain")),a=y(e("__sk_inst_functions",r),t),c=C(e("__sk_inst_functions",n),e("__sk_inst_functions",n),e("process","domain"));return k("||",S([o,i,a,y(e("process","domain"),c),x(e("__sk_inst_functions",n))]),e("__sk_inst_functions",r))}function I(e){if(e&&e.length)for(let t=0;t<e.length;++t){if(e[t].range)return e[t].range;if(e[t].callee&&e[t].callee.object&&e[t].callee.object.elements)return I(e[t].callee.object.elements)}}function O(e){if(0===e.expressions.length)return e;const t=[];e.quasis.forEach(e=>{e.value.cooked&&t.push({item:E(e.value.cooked),start:e.range[0],end:e.range[1]})});for(let n=0;n<e.expressions.length;++n){const s=e.expressions[n];if(s.range)t.push({item:s,start:s.range[0],end:s.range[1]});else{if(!s.arguments)return f.warn("Could not parse expression for node: "+r.inspect(e)),e;{const n=I(s.arguments);if(n)t.push({item:s,start:n[0],end:n[1]});else{if(!(s.callee&&s.callee.object&&s.callee.object.elements))return f.warn("Could not parse expression for node: "+r.inspect(e)),e;{const n=I(s.callee.object.elements);if(!n)return f.warn("Could not parse expression for node: "+r.inspect(e)),e;t.push({item:s,start:n[0],end:n[1]})}}}}}return t.sort((e,t)=>e.start>t.start?1:e.start===t.start&&e.end>t.end?1:-1),s(b(t.map(e=>e.item)),"join",[E("")])}function R(e){switch(e.type){case"BinaryExpression":switch(e.operator){case"+":return"Literal"!==e.left.type||"Literal"!==e.right.type?s("__sk_inst_functions","plus",[e.left,e.right]):e}break;case"AssignmentExpression":if("+="===e.operator)return y(e.left,s("__sk_inst_functions","plus",[e.left,e.right]));break;case"CallExpression":{const t=d.get(e.callee.name);if(t&&t.includes("call")&&e.arguments&&e.arguments.length>0)return s("__sk_inst_functions","call"+e.callee.name+"Ctor",e.arguments);if("Function"===e.callee.name&&e.arguments&&e.arguments.length>0)return v(e);if("eval"===e.callee.name&&e.arguments&&1===e.arguments.length)return v(e);if(e.callee.object&&"crypto"===e.callee.object.name&&e.callee.property&&"createCipher"===e.callee.property.name&&e.arguments&&e.arguments.length>0)return s("__sk_inst_functions","cryptoCreateCipher",e.arguments);break}case"NewExpression":{let t,n;if(e.callee.name&&(t=d.get(e.callee.name),n=e.callee.name),e.callee.object&&e.callee.object.name&&(t=d.get(e.callee.object.name+"."+e.callee.property.name),n=e.callee.object.name+e.callee.property.name),t&&t.includes("newSelf")&&e.arguments&&e.arguments.length>0)return s("__sk_inst_functions","newSelf"+n+"Ctor",[e]);if(t&&t.includes("new")&&e.arguments&&e.arguments.length>0)return s("__sk_inst_functions","new"+n+"Ctor",e.arguments);if("Function"===e.callee.name&&e.arguments&&e.arguments.length>0)return v(e);break}case"AwaitExpression":return F(e);case"TemplateLiteral":return O(e)}}function q(e){t.readdirSync(e).forEach(r=>{const s=n.join(e,r);const o=t.statSync(s);o.isDirectory()?q(s):(s.endsWith(".BEFORE.js")||s.endsWith(".AFTER.js"))&&t.unlinkSync(s)});try{t.rmdirSync(e)}catch(e){if("ENOTEMPTY"===e.code)return;throw e}}function D(e){if(e&&e!==W){if(t.existsSync(e))try{q(e)}catch(t){f.error("Failed to clean directory for dump instrumentation %s: %s",e,t)}else try{t.mkdirSync(e)}catch(t){return f.error("Failed to create directory to dump instrumentation in %s: %s",e,t),void(M=!1)}W=e,M=!0,f.info("Instrumented files will be dumped into %s",e)}}function N(e){for(let t of _)if(e.includes(t.file))return t}function T(){!M&&h.config&&h.config.processCfg&&h.config.processCfg.projectEnvCfg&&"TRACE"===h.config.processCfg.projectEnvCfg.diagLevel&&(D(n.join(h.config.collectorCfg.logging.dir,"inst")),f.trace("Remember that at this point, lots of files have already been instrumented. Use '%s' environment variable to activate dumps as soon as the process starts.",p.ENV_DUMP_INSTRUMENTATION_DIR))}function L(e,s,o){try{e=n.join(W,e.replace(/^(.*)\.js$/,r.format("$1.%s.js",o)).replace(":","")),h.services.instrumentation.safeExecuteWithoutInstrumentation(()=>{m.mkDirsSync(n.dirname(e),511);t.writeFileSync(e,s)})}catch(t){f.warn("Failed to write instrumentation dump %s: %s",e,t)}}function U(e,n){try{t.writeFileSync(e,n)}catch(e){f.warn(e)}}function A(e,r){const s=function(e,r){const s=i.createHash("sha256").update(r).digest("hex"),o=n.resolve(g,s);if(t.existsSync(o))try{return t.readFileSync(o).toString()}catch(e){f.warn(e)}M&&e&&L(e,r,"BEFORE");let a=null;try{a=c.parse(r,{range:!0,tolerant:!0,tokens:!0,comment:!0,sourceType:"script"})}catch(t){return f.warn("Failed to parse source code for %s: %s",e,t.message),U(o,r),r}if(!a)return f.warn("Failed to create source code tree for unknown reason for %s",e),U(o,r),r;try{a=u.attachComments(a,a.comments,a.tokens)}catch(t){f.debug("Failed to preserve comments in instrumented source code for %s: %s",e,t.message)}l.replace(a,{leave:function(t){t.trailingComments&&delete t.trailingComments;const n=e&&N(e);if(!n||!(n.operator&&n.operator.includes(t.operator)||n.callee&&t.callee&&n.callee.includes(t.callee.name)))return R(t)}}),r=u.generate(a,{sourceCode:r,format:{compact:!1,preserveBlankLines:!0},comment:!0});const m=new RegExp("return;[\\s\\n]*?`","gm"),p="return `";return m.test(r)&&f.trace("Found match for 'return;' in %s",e),r=r.replace(m,"return `"),M&&e&&L(e,r,"AFTER"),U(o,r),r};return h?h.services.instrumentation.safeExecuteWithoutInstrumentation(()=>s(e,r)):s(e,r)}let W,M;D(p.getInstrumentationDumpDir()),this.init=function(e){h=e,a.wrap(Object.getPrototypeOf(module),"_compile",function(e){return function(t,n){const r=m.normalizeToUnixPath(n),s=m.normalizeToUnixPath(__dirname);return-1===r.indexOf(s.substring(0,s.lastIndexOf("/")))&&(t=A(r,t),f.trace("File instrumented: %s",r)),e.apply(this,[t,n])}})},this.start=function(){T()},this.registerConstructor=function(e){if("global"!==e.moduleId){e.identifiers||(e.identifiers=[e.moduleId]);for(let t=0;t<e.identifiers.length;++t){const n="global"===e.moduleId?e.wrapperName:e.identifiers[t]+"."+e.wrapperName,r=d.get(n);r?(r.push(e.methodName),d.set(n,r)):d.set(n,[e.methodName])}}else{const t="global"===e.moduleId?e.wrapperName:e.moduleId+"."+e.wrapperName,n=d.get(t);n?(n.push(e.methodName),d.set(t,n)):d.set(t,[e.methodName])}},this._instrumentSourceCode=function(e,t){return A(e,t)},this._excludeSourceCodeInstrumentation=function(e){_.push(e)}}const t=require("fs"),n=require("path"),r=require("util"),s=require("url"),o=require("lodash"),i=require("crypto"),a=require("shimmer"),c=require("esprima"),u=require("escodegen"),l=require("estraverse"),f=require("../util/logger"),m=require("../util/misc"),p=require("../util/internal-settings"),_=require("../resources/excluded-sourcecode-inst.json"),g=m.getInstDir();t.existsSync(g)||m.mkDirsSync(g);const d=new Map;let h;global.__sk_inst_functions={plus:function e(t,n){return t+n},eval:function(){return!1},sourceCode:function(e){return module.exports._instrumentSourceCode(null,e)},newStringCtor:function(e){return new String(e)},callStringCtor:function(e){return String(e)},callObjectCtor:function(e){return Object(e)},newObjectCtor:function(e){return new Object(e)},newRegExpCtor:function(e,t){return new RegExp(e,t)},newurlURLCtor:function(e,t){return new s.URL(e,t)},newUrlURLCtor:function(e,t){return new s.URL(e,t)},newSelfErrorCtor:function(e){return e},newSelfMongoErrorCtor:function(e){return e},cryptoCreateCipher:function(){return i.createCipher.apply(i,arguments)},asyncDomainCounter:0,deleteOldAwaitResultsWithoutDomain:function(){const e=Object.keys(__sk_inst_functions);for(let t=0;t<e.length;++t)if(e[t].startsWith("__sk_await_result_")){const n=e[t].replace("__sk_await_result_","__sk_process_domain_");Object.prototype.hasOwnProperty.call(global,n)||delete __sk_inst_functions[e[t]]}}},module.exports=new e;