"use strict";function e(e){let t=!1;this.type=e,this.count=0,this.lastSeenOn=null,this.inc=function e(){this.count++,t=!0,this.lastSeenOn=Date.now()},this.isUpdated=function e(){return t}}function t(e){const t=5;let s=0,o=0;this.filter=function t(n){if(!module.exports.cfg||!module.exports.cfg.monitoredDataTypes||-1===module.exports.cfg.monitoredDataTypes.indexOf(e))return!1;if(!n)return!0;if(-1===module.exports.verboseEnabledTypes.indexOf(e))return!1;if("ALL"===module.exports.cfg.verboseMode)return!0;const i=Math.round(Date.now()/1e3);return s===i?5!==o&&(o++,!0):(s=i,o=1,!0)}}function s(){function s(e){const t=u.services.http.getCurrentRequestData(),s={timestamp:Date.now(),userAgent:t?t.getFirstHeader("user-agent"):null,remoteAddr:t?t.remoteAddr:null};for(let t in e)s[t]=e[t];d.push(s)}function n(){const e=new t("HTTP");u.services.http.on(null,"requestEnded",function(t){if(e.filter(!1)&&l.HTTP.inc(),e.filter(!0)){const e=u.services.http.getCurrentRequestData(),o=u.services.process_version;e&&s({class:"HTTP",type:"HTTP",url:e.url,method:e.method,params:e.params,headers:e.headers,responseCode:t.responseData.statusCode,projectVersion:o.isFeatureEnabled()?o.getProjectVersion():null})}})}function i(){const e=new t("SQL");u.services.sql.on(null,"query",function(t){e.filter(!1)&&l.SQL.inc(),e.filter(!0)&&s({class:"SQL",type:"SQL",sql:t.statement})})}function r(){const e=new t("FILE_WRITING");u.services.fs.on(null,"write",function(t){e.filter(!1)&&l.FILE_WRITING.inc(),e.filter(!0)&&s({class:"FILE_WRITING",type:"FILE_WRITING",path:t.filepath})})}function c(){for(let e in l){const t=l[e];t.isUpdated()&&u.services.collector.wsSend({command:"Activity.Summary.Push",data:{type:"com.synopsys.seeker.commons.objects.messages.data.ActivitySummaryPushCommandData",activityData:t,executionUuid:u.config.bootstrapCfg.executionUuid}})}setTimeout(c,module.exports.summaryInterval)}function a(){if(0!==d.length){const e=d;d=[],u.services.collector.wsSend({command:"Activity.Verbose.Push",data:{type:"com.synopsys.seeker.commons.objects.messages.data.ActivityVerbosePushCommandData",activityData:e,executionUuid:u.config.bootstrapCfg.executionUuid}}),setTimeout(a,module.exports.verboseInterval)}else setTimeout(a,module.exports.verboseInterval)}let u,f=!1;const l={HTTP:new e("HTTP"),SQL:new e("SQL"),FILE_WRITING:new e("FILE_WRITING")};let d=[];this.summaryInterval=2e3,this.verboseInterval=1e3,this.cfg={},this.verboseEnabledTypes=[],this.init=function(e){u=e},this.start=function(){this.cfg=u.config.processCfg.activityMonitoringCfg,(f=u.config.processCfg.features.indexOf("ACTIVITY_MONITORING")>-1)&&(n(),i(),r(),c(),a(),u.services.collector.on("Activity.VerboseActivation.Toggle",e=>{o.debug("Toggle verbose activity monitoring to %s",e.data.verboseEnabledTypes);module.exports.verboseEnabledTypes=e.data.verboseEnabledTypes}),u.services.collector.on("ProjectCfg.Push",e=>{try{module.exports.cfg=e.data.projectCfg.projectEnvCfgs.default.processCfgs.default.activityMonitoringCfg}catch(t){o.warn("Failed to find the default process configuration from the incoming message after project settings were changed: %s",JSON.stringify(e.data.projectCfg))}}))},this._isActive=function e(){return f},this._isVerboseFor=function e(t){return-1!==this.verboseEnabledTypes.indexOf(t)}}const o=require("../util/logger");module.exports=new s;