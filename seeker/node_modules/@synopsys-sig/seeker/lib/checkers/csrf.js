"use strict";function e(s,r){function o(){if(t.active&&t.active.__sk_local)return t.active.__sk_local.csrfContext}function a(e){const t=o();t&&(t.requiresProtection=!0,t.accessedFiles||(t.accessedFiles=[]),t.accessedFiles.push(e))}function c(e){const t=o();if(t){const s=e();s.stateChange&&(t.requiresProtection=!0,t.databaseQueries||(t.databaseQueries=[]),t.databaseQueries.push(s.query))}}function u(e){return e?e.join(","+d):"[N/A]"}const d=require("os").EOL;e.super_.apply(this,arguments),s.services.http.on(r,"requestStarted",function(e){"POST"===e.requestData.method.toUpperCase()&&void 0!==e.requestData.contentType&&(e.requestData.contentType.toLowerCase().indexOf("application/x-www-form-urlencoded")>=-1||e.requestData.contentType.toLowerCase().indexOf("multipart/form-data")>=-1||e.requestData.contentType.toLowerCase().indexOf("text/plain")>=-1)&&(e.csrfContext={isExposed:!0,requiresProtection:!1})}),s.services.http.on(r,"requestEnded",function(e){e.csrfContext&&e.csrfContext.isExposed&&e.csrfContext.requiresProtection&&!n.moduleLoaded("crumb/lib/index")&&!n.moduleLoaded("@hapi/crumb/lib/index")&&new i(r).withContext({accessedFiles:u(e.csrfContext.accessedFiles),databaseQueries:u(e.csrfContext.databaseQueries)}).withDefaults().submit()}),s.services.csrf.on(r,"verify",function(){const e=o();e&&(e.isExposed=!1)}),s.services.sql.on(r,"query",function(e){c(function(){let t={};return t.query=e.statement.toLowerCase().trim(),t.stateChange=t.query.startsWith("insert")||t.query.startsWith("delete")||t.query.startsWith("update"),t})}),s.services.nosql.on(r,"command",function(e){c(function(){let t={};return e.command&&e.command.query&&(t.query=JSON.stringify(e.command.query),t.stateChange=t.query.startsWith('{"insert"')||t.query.startsWith('{"delete"')||t.query.startsWith('{"update"')),t})}),s.services.fs.on(r,"write",function(e){a(e.filepath)}),s.services.fs.on(r,"unlink",a)}const t=require("domain"),s=require("util"),r=require("./_AbstractChecker"),i=require("../services/finding-service").FindingBuilder,n=require("../services/instrumentation-service");s.inherits(e,r),module.exports=function(t,s){return new e(t,s)};